--- imagick.c.bak	2025-09-22 00:21:40
+++ imagick.c	2025-09-22 00:30:10
@@ -24,7 +24,9 @@
 #include "php_imagick_helpers.h"
 #include "php_imagick_shared.h"
 
-#if PHP_VERSION_ID >= 70000
+#if PHP_VERSION_ID >= 80100
+#include "zend_smart_str.h"
+#elif PHP_VERSION_ID >= 70000
 #include "ext/standard/php_smart_string.h"
 #else
 #include "ext/standard/php_smart_str.h"
@@ -1126,8 +1128,7 @@
 
 PHP_MINFO_FUNCTION(imagick)
 {
-
-#if PHP_VERSION_ID >= 70000
+#if PHP_VERSION_ID >= 70000 && PHP_VERSION_ID < 80100
 	smart_string formats = {0};
 #else
 	smart_str formats = {0};
@@ -1163,27 +1164,31 @@
 
 	if (supported_formats) {
 		for (i = 0; i < num_formats; i++) {
-#if PHP_VERSION_ID >= 70000
+#if PHP_VERSION_ID >= 70000 && PHP_VERSION_ID < 80100
 			if (i != 0) {
  				smart_string_appends(&formats, ", ");
 			}
 			smart_string_appends(&formats, supported_formats[i]);
 #else
-			smart_str_appends(&formats, supported_formats[i]);
-			if (i != (num_formats - 1)) {
+			if (i != 0) {
 				smart_str_appends(&formats, ", ");
 			}
+			smart_str_appends(&formats, supported_formats[i]);
 #endif
 			IMAGICK_FREE_MAGICK_MEMORY(supported_formats[i]);
 		}
 		
-#if PHP_VERSION_ID >= 70000
+#if PHP_VERSION_ID >= 70000 && PHP_VERSION_ID < 80100
 		smart_string_0(&formats);
 		php_info_print_table_row(2, "ImageMagick supported formats", formats.c);
 		smart_string_free(&formats);
 #else
 		smart_str_0(&formats);
+#if PHP_VERSION_ID >= 80100
+		php_info_print_table_row(2, "ImageMagick supported formats", ZSTR_VAL(formats.s));
+#else
 		php_info_print_table_row(2, "ImageMagick supported formats", formats.c);
+#endif
 		smart_str_free(&formats);
 #endif
 		IMAGICK_FREE_MAGICK_MEMORY(supported_formats);
